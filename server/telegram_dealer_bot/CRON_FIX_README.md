# Исправление проблем с cron-задачами

## Проблема

Cron-задачи переставали работать после первого выполнения, требовался перезапуск сервера каждое утро.

## Причины

1. **Блокирующие I/O операции** - сетевые соединения блокировали выполнение
2. **Отсутствие обработки ошибок** - задачи падали и не перезапускались
3. **Проблемы с управлением cron-задачами** - отсутствие мониторинга и автоматического восстановления

## Решение

### 1. Новый CronManager

Создан класс `CronManager` (`helpers/cronManager.js`) который:

- Отслеживает состояние всех cron-задач
- Автоматически перезапускает зависшие задачи
- Ведет статистику выполнения
- Предотвращает одновременное выполнение одной задачи

### 2. Улучшенные сетевые функции

- Добавлены таймауты для подключения и ответа
- Улучшена обработка ошибок и очистка ресурсов
- Предотвращение блокировки выполнения

### 3. Мониторинг здоровья

- Автоматическая проверка состояния задач каждые 5 минут
- Перезапуск задач с критическим количеством ошибок
- Обнаружение зависших задач (выполняющихся более 30 минут)

### 4. API для управления

Добавлены новые endpoints:

- `GET /api/cron/status` - статус всех cron-задач
- `POST /api/cron/restart/:jobName` - перезапуск конкретной задачи
- `POST /api/cron/stop` - остановка всех задач
- `POST /api/cron/start` - запуск всех задач

## Использование

### Запуск сервера

```bash
cd server/telegram_dealer_bot
npm start
```

### Проверка статуса cron-задач

```bash
curl http://localhost:5778/api/cron/status
```

### Перезапуск задачи

```bash
curl -X POST http://localhost:5778/api/cron/restart/reclamation
```

### Тестирование

```bash
node test-cron.js
```

## Мониторинг

### Логи

- `[CRON_MANAGER]` - сообщения от менеджера cron-задач
- `[NETWORK]` - сетевые операции
- `[CRON][V6Z]` / `[CRON][V0Z]` - выполнение конкретных задач

### Автоматические действия

- Задачи с 5+ ошибками автоматически перезапускаются
- Зависшие задачи (>30 минут) автоматически перезапускаются
- Мониторинг каждые 5 минут

## Конфигурация

### Таймауты

- Подключение: 10 секунд
- Ответ сервера: 30 секунд
- Проверка здоровья: 5 минут
- Критический порог зависания: 30 минут

### Расписание

- Рекламации: `0 10-19/2 * * *` (каждые 2 часа с 10:00 до 19:00)
- Сверка заказов: `35 9 * * *` (каждый день в 9:35)

## Устранение неполадок

### Задача не выполняется

1. Проверить статус: `GET /api/cron/status`
2. Перезапустить задачу: `POST /api/cron/restart/:jobName`
3. Проверить логи на наличие ошибок

### Сервер недоступен

1. Проверить доступность `192.168.57.77:8240`
2. Проверить сетевые настройки
3. Использовать `checkServerHealth()` для диагностики

### Высокое потребление ресурсов

1. Проверить зависшие задачи в логах
2. Уменьшить частоту проверки здоровья
3. Настроить более строгие таймауты

## Безопасность

- Все сетевые операции имеют таймауты
- Автоматическое восстановление после сбоев
- Логирование всех операций для аудита
- Graceful shutdown при завершении работы

## Производительность

- Асинхронное выполнение задач
- Предотвращение блокировки I/O
- Эффективное управление ресурсами
- Автоматическая очистка соединений
