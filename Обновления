# Обновления компонента MissedCall.jsx

## Дата: 2024-12-19

### Что было обновлено:
1. **Улучшена логика фильтрации пропущенных звонков** - теперь компонент правильно отображает звонки в зависимости от роли пользователя
2. **Добавлены новые API endpoints** на сервере CRM-server:
   - `/api/user-info/:userId` - получение информации о пользователе с ролью и отделом
   - `/api/department-employees/:departmentId` - получение сотрудников отдела для руководителей
   - `/api/calls-employees` - получение всех сотрудников, которые есть в звонках (для фильтров)
3. **Обновлен API endpoint** `/api/calls` - добавлена поддержка фильтрации по отделам и сотрудникам
4. **Добавлены новые фильтры** для пользователей с правами на просмотр всех звонков:
   - Фильтр по сотрудникам отдела (для руководителей)
   - Фильтр по неопределенным звонкам
   - Фильтр по конкретным сотрудникам
   - **НОВОЕ**: Фильтр по всем сотрудникам из звонков (включая Мизинцова и других)
5. **Улучшен UI** - добавлена информационная панель с текущими правами пользователя
6. **Исправлена логика определения руководителя отдела** - теперь проверяется должность "Руководитель отдела", а не конкретный отдел
7. **Устранены постоянные ререндеры** - оптимизированы зависимости в useCallback и useEffect
8. **Обновлены связанные компоненты** - `AcceptedCalls.jsx` и `ProcessedCalls.jsx` получили аналогичную логику

### Технические детали:
- Использован `useMemo` для API URL
- Разделены `useEffect` на логические блоки
- Добавлена проверка `if (!userInfo) return` в функциях загрузки
- Оптимизированы зависимости в `useCallback`

### Результат:
Теперь пользователи с правами на просмотр всех звонков (НОК, Администратор, Руководитель отдела) могут:
- Видеть все звонки в соответствии со своими правами
- Фильтровать звонки по конкретным сотрудникам, включая всех сотрудников из звонков
- Фильтровать по неопределенным звонкам
- Руководители отделов видят звонки только своего отдела

Обычные пользователи видят только свои звонки.

---

# Обновления компонента AcceptedCalls.jsx

## Дата: 2024-12-19

### Что было обновлено:
1. **Добавлена та же логика фильтрации** что и в MissedCall.jsx для консистентности
2. **Обновлена функция `fetchAcceptedCalls`** с поддержкой фильтрации по ролям и отделам
3. **Добавлены фильтры по сотрудникам** для пользователей с правами на просмотр всех звонков
4. **Добавлена информационная панель** с текущими правами пользователя
5. **Улучшена архитектура** - добавлены useCallback и правильные зависимости useEffect

### Технические изменения:
- Переписана функция `fetchAcceptedCalls` с новой логикой фильтрации
- Добавлена функция `fetchUserInfo` для получения информации о пользователе
- Добавлены новые состояния для управления фильтрами
- Обновлены зависимости useEffect для корректной работы
- Добавлены UI элементы для фильтрации по сотрудникам

---

# Обновления компонента ProcessedCalls.jsx

## Дата: 2024-12-19

### Что было обновлено:
1. **Добавлена та же логика фильтрации** что и в других компонентах звонков для консистентности
2. **Обновлена функция `fetchProcessedCalls`** с поддержкой фильтрации по ролям и отделам
3. **Добавлены фильтры по сотрудникам** для пользователей с правами на просмотр всех звонков
4. **Добавлена информационная панель** с текущими правами пользователя
5. **Улучшена архитектура** - добавлены useCallback и правильные зависимости useEffect

### Технические изменения:
- Переписана функция `fetchProcessedCalls` с новой логикой фильтрации
- Добавлена функция `fetchUserInfo` для получения информации о пользователе
- Добавлены новые состояния для управления фильтрами
- Обновлены зависимости useEffect для корректной работы
- Добавлены UI элементы для фильтрации по сотрудникам

---

# Исправления логики и устранение ререндеров

## Дата: 2024-12-19

### Что было исправлено:
1. **Исправлена логика определения руководителя отдела** - теперь проверяется должность "Руководитель отдела", а не конкретный отдел
2. **Устранены постоянные ререндеры** компонентов из-за неправильных зависимостей в useCallback и useEffect
3. **Оптимизированы useEffect** - разделены на логические блоки с правильными зависимостями
4. **Добавлена мемоизация** API URL для предотвращения лишних ререндеров

### Технические исправления:
- **Сервер**: Изменена логика в `/api/user-info/:userId` - теперь `isDepartmentHead` определяется по `position_name === 'Руководитель отдела'`
- **Компоненты**: 
  - Добавлен `useMemo` для API URL
  - Разделены useEffect на инициализацию, загрузку звонков и socket подключение
  - Убраны лишние зависимости из useCallback
  - Добавлена проверка `if (!userInfo) return` в функциях загрузки звонков
- **Логика**: Руководитель отдела теперь видит звонки сотрудников своего отдела независимо от названия отдела

### Результат:
- Компоненты больше не ререндерятся постоянно
- Правильная логика работы с ролями пользователей
- Руководители отделов видят звонки сотрудников своего отдела
- Оптимизированная производительность

---

# Новая логика фильтров по ролям пользователей

## Дата: 2024-12-19

### Что было изменено:
1. **НОК и Руководитель отдела** - теперь видят только сотрудников своего отдела в фильтрах
2. **Администратор** - продолжает видеть всех сотрудников из звонков
3. **Фильтр "Все сотрудники"** - динамически меняется:
   - Для НОК и руководителей: "Сотрудники отдела"
   - Для администраторов: "Все сотрудники"
4. **Разделен фильтр "Неопределенные"** на два типа:
   - "Неопределенные по сотруднику" - где сотрудник не определен
   - "Неопределенные по входящему звонку" - где звонящий не определен

### Технические изменения:
- **Сервер**: Добавлен новый параметр `unassignedCaller` в API `/api/calls`
- **Компоненты**: 
  - Добавлено состояние `selectedUnassignedType` для управления типами неопределенных
  - Обновлена логика `fetchUserInfo` - НОК и руководители загружают только сотрудников отдела
  - Обновлены UI фильтры с новыми кнопками
  - Добавлена поддержка новых параметров в функциях загрузки звонков

### Логика работы фильтров:
- **НОК**: Видит сотрудников своего отдела + фильтры неопределенных
- **Руководитель отдела**: Видит сотрудников своего отдела + фильтры неопределенных  
- **Администратор**: Видит всех сотрудников + фильтры неопределенных
- **Обычный пользователь**: Не видит фильтры, только свои звонки

### Результат:
Теперь фильтры работают корректно для каждой роли пользователя, обеспечивая правильное разделение доступа к данным.

---

## Упрощение фильтра "Неопределенные" (последнее обновление)

### Изменения:
- **Убран фильтр**: "Неопределенные по входящему звонку" 
- **Оставлен только**: "Неопределенный сотрудник" - показывает звонки где сотрудник (получатель) не был найден
- **Обновлены компоненты**: `MissedCall.jsx`, `AcceptedCalls.jsx`, `ProcessedCalls.jsx`
- **Упрощен серверный API**: удален параметр `unassignedCaller` из `/api/calls`

### Результат:
Интерфейс стал более простым и понятным - теперь есть только один фильтр для неопределенных звонков, который фокусируется на случаях, когда не удалось определить сотрудника-получателя.

---

## Исправление логики фильтра "Неопределенный сотрудник" (последнее обновление)

### Проблема:
Фильтр "Неопределенный сотрудник" работал неправильно - показывал звонки где не определен звонящий, а не получатель.

### Исправление:
- **Серверный API**: Изменена логика фильтра `unassigned` в `/api/calls`
- **Было**: `(users.id IS NULL AND dealers.id IS NULL)` - проверял звонящего
- **Стало**: `(users2.id IS NULL AND dealers2.id IS NULL)` - проверяет получателя

### Результат:
Теперь фильтр "Неопределенный сотрудник" корректно показывает звонки где:
- В поле "Получатель" есть номер телефона
- Но нет определенного сотрудника в скобках (например: "79470802682 ( )" вместо "79470802682 (Иванов Иван)")

---

## Счетчик пропущенных звонков с учетом фильтров (последнее обновление)

### Проблема:
Счетчик пропущенных звонков в меню "Телефония (asterisk)" показывал общее количество пропущенных звонков, не учитывая активные фильтры в компоненте "Пропущенные звонки".

### Реализация:
- **Store**: Добавлено состояние `missedCallFilters` в `callsNotificationStore` для хранения активных фильтров
- **MissedCall.jsx**: Добавлена синхронизация фильтров с store при их изменении
- **App.jsx**: Обновлена логика подсчета пропущенных звонков с учетом фильтров из store

### Результат:
Теперь счетчик в меню динамически обновляется в зависимости от выбранных фильтров:
- При выборе конкретного сотрудника - показывает количество его пропущенных звонков
- При включении фильтра "Неопределенный сотрудник" - показывает количество неопределенных звонков
- Учитывает права доступа пользователя (НОК, Руководитель отдела, Администратор)

---

## Улучшение визуального дизайна счетчиков (последнее обновление)

### Что было улучшено:
1. **Счетчик пропущенных звонков**:
   - Современный дизайн с градиентным фоном и тенями
   - Анимация пульсации для привлечения внимания
   - Адаптивный размер для больших чисел (99+, 999+)
   - Hover эффекты с увеличением и изменением теней

2. **Счетчики рабочих групп**:
   - Градиентные фоны для разных типов задач
   - Добавлены tooltip'ы для лучшего понимания
   - Hover эффекты с плавными переходами

3. **Счетчик напоминаний**:
   - Улучшенный дизайн с фоном и рамкой
   - Hover эффекты для лучшей интерактивности

4. **Общие улучшения**:
   - Плавные анимации появления и перехода
   - Адаптивность для мобильных устройств
   - Улучшенная читаемость с text-shadow и letter-spacing
   - Единый стиль для всех типов счетчиков

### Технические детали:
- Добавлены CSS анимации: `pulse-glow`, `slideIn`, `pulse`
- Использованы CSS градиенты для современного вида
- Добавлены медиа-запросы для мобильных устройств
- Улучшена типографика с помощью text-shadow и letter-spacing
