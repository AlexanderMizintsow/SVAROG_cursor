# Обновления проекта

## Улучшение UX для переноса даты заказов 1С

**Дата:** Текущая дата
**Файл:** `server/telegram_dealer_bot/queryLines/orders1c/orderHandlers.js`

### Внесенные изменения:

1. **Улучшение видимости сообщения с запросом причины переноса:**
   - Заменено редактирование сообщения на отправку нового сообщения
   - Новое сообщение теперь отображается последним в чате
   - Добавлены эмодзи и Markdown-форматирование для лучшего восприятия
   - Добавлено предупреждение о необходимости ответа

2. **Улучшение сообщения с выбором даты:**
   - Добавлено Markdown-форматирование
   - Улучшены инструкции для пользователя
   - Добавлены эмодзи для лучшей навигации

3. **Автоматическая очистка промежуточных сообщений:**
   - После завершения переноса даты автоматически удаляются все промежуточные сообщения
   - Удаляется сообщение с выбором даты
   - Удаляется сообщение с запросом причины переноса
   - Остается только финальное подтверждение успешного переноса
   - При отмене переноса также очищаются все промежуточные сообщения

### Цель изменений:
- Решить проблему "потери" сообщения с запросом причины переноса
- Сделать процесс переноса даты более понятным для дилеров
- Улучшить общий пользовательский опыт при работе с заказами
- Избежать путаницы с кнопками отмены после завершения операции
- Обеспечить чистоту чата после завершения операций

### Затронутые компоненты:
- Обработка выбора новой даты заказа
- Запрос причины переноса даты
- Форматирование сообщений в Telegram-боте
- Автоматическая очистка сообщений
- Обработка отмены операций

---

## Изменения в расписании cron-задач для заказов 1С

**Дата:** Текущая дата
**Файл:** `server/telegram_dealer_bot/queryLines/orders1c/orders1c.js`

### Внесенные изменения:

1. **Основная задача отправки уведомлений дилерам:**
   - Расписание изменено с `'* * * * *'` на `'0 9 * * *'` (каждый день в 9:00 утра)
   - Уведомления о заказах теперь отправляются строго в 9:00 утра

2. **Задача проверки ответов дилеров:**
   - Расписание изменено с `'*/3 * * * *'` на `'0 12 * * *'` (каждый день в 12:00 дня)
   - Проверка ответов дилеров и уведомления МПП происходят строго в 12:00 дня

### Цель изменений:
- Установить фиксированное время отправки уведомлений дилерам в 9:00 утра
- Установить фиксированное время проверки ответов и уведомления МПП в 12:00 дня
- Обеспечить предсказуемый график работы системы заказов 1С
- Соответствовать бизнес-логике: дилеры получают уведомления утром и должны ответить до полудня

### Затронутые компоненты:
- Cron-задачи для заказов 1С
- Проверка поздних ответов дилеров
- Уведомления МПП
- Временные рамки для ответов дилеров

## Добавлена функциональность для обработки заказов 1С

### Созданные файлы:
1. **server/telegram_dealer_bot/queryLines/orders1c/orders1c.js** - Основная логика обработки заказов 1С
2. **server/telegram_dealer_bot/queryLines/orders1c/orderHandlers.js** - Обработчики callback-запросов от дилеров

### Внесенные изменения:

#### В файл server/telegram_dealer_bot/routes/auth.js:
- Добавлены импорты функций обработки заказов 1С
- Добавлены обработчики callback-запросов для заказов 1С в функцию handleCallbackQuery
- Добавлена обработка текстовых сообщений для причин переноса заказов в функцию handleUserMessage

#### В файл server/telegram_dealer_bot/index.js:
- Добавлен импорт функции initOrders1CCron
- Добавлена инициализация cron-задач для заказов 1С
- Обновлена функция gracefulShutdown для корректной остановки новых cron-задач

### Функциональность:

#### Основные возможности:
1. **Получение заказов 1С** - ежедневно в 9:00 утра
2. **Фильтрация по дате** - отправка только заказов на второй день от запроса
3. **Отправка уведомлений дилерам** - с кнопками подтверждения и переноса даты
4. **Обработка ответов дилеров** - подтверждение даты или запрос переноса
5. **Автоматическое уведомление МПП** - о действиях дилеров (исправлена логика получения userId)
6. **Блокировка ответов после 12:00** - автоматическое уведомление МПП о просроченных ответах

#### Исправления в логике уведомлений МПП:
- Добавлен chat_id в заголовки уведомлений для идентификации пользователя Telegram
- Исправлен способ получения userId для МПП через API-запросы (аналогично другим модулям)
- Убрана логика fallback на МПР - уведомления отправляются только МПП
- Добавлена обработка ошибок при получении userId

#### Исправления в логике обработки переноса даты:
- Добавлено подробное логирование для отладки проблем с сессиями
- Улучшены сообщения об ошибках с указанием номера заказа
- Добавлена диагностика состояния сессии на каждом этапе
- Убраны лишние запросы к БД для поиска заказа - используется только информация из сессии
- Упрощена логика - заказ ищется только при необходимости обновления статуса
- Исправлена логика генерации дат: ближайшая дата теперь через 2 дня от текущей
- Добавлена обработка воскресенья - если начальная дата воскресенье, переносится на понедельник
- Улучшены сообщения пользователю с указанием правильных ограничений по датам
- **ИСПРАВЛЕНО**: Корректное извлечение orderNumber из awaitingDateSelection в handleRescheduleReason
- Добавлено дополнительное логирование для отслеживания состояния сессии на каждом этапе
- **УЛУЧШЕНО**: Логика расчета ближайшей доступной даты теперь правильно пропускает воскресенье
- Если дата +2 дня попадает на воскресенье, автоматически переносится на понедельник
- Добавлено подробное логирование процесса расчета дат для отладки
- **ИСПРАВЛЕНО**: Логика расчета дат теперь правильно учитывает воскресенье в промежутке
- Вместо простого добавления 2 дней, система проходит по дням по одному, пропуская воскресенье
- Теперь если завтра воскресенье, ближайшая дата будет вторник (через 3 дня), а не понедельник

#### Cron-задачи:
- **Основная задача**: ежедневно в 9:00 - получение и обработка заказов
- **Задача проверки поздних ответов**: каждый час с 12:00 до 18:00 - проверка и блокировка просроченных ответов

#### Тестовый режим:
- Включен по умолчанию с закодированными тестовыми данными
- Настоящий запрос к 1С закомментирован для удобства переключения

### База данных:
Используется существующая таблица `orders_1c` для хранения информации о заказах, статусах уведомлений и ответах дилеров.

### Интеграция:
Функциональность полностью интегрирована в существующую архитектуру проекта, использует существующие механизмы:
- Отправки уведомлений МПП через createReminder
- Обработки callback-запросов
- Управления cron-задачами через CronManager
- Работы с базой данных через dbPool

## Функция загрузки скриншотов через Ctrl+V в чат задач

**Дата:** $(Get-Date -Format "dd.MM.yyyy HH:mm")

**Описание изменений:**
- Добавлена функция автоматической загрузки скриншотов через вставку Ctrl+V в чат задач
- Реализована обработка изображений из буфера обмена в компоненте `chatTaskModal`
- Добавлен обработчик `onPaste` для поля ввода сообщения
- Интегрирована функция вставки скриншотов в компонент `ChatFileUploader`
- Добавлена визуальная подсказка "Ctrl+V для скриншота" в заголовок чата
- Автоматическое создание уникальных имен для скриншотов с временными метками
- Сохранена вся существующая логика работы с файлами и изображениями

**Исправления дублирования:**
- Устранено дублирование сообщений при отправке скриншотов
- Убран дублирующий обработчик `onPaste` с модального окна
- Оставлен только один обработчик на поле ввода сообщения
- Добавлен флаг `isProcessingPaste` для предотвращения повторной обработки
- Реализована проверка на дублирование изображений по хешу содержимого
- Проверка последних 5 сообщений на наличие дублирующихся скриншотов

## Разделение файлов по отправителям в менеджере файлов

**Дата:** $(Get-Date -Format "dd.MM.yyyy HH:mm")

**Описание изменений:**
- Добавлено разделение файлов в менеджере файлов чата по отправителям
- Созданы вкладки "Мои файлы" и "Файлы от других пользователей"
- Реализована фильтрация файлов по текущему пользователю и другим участникам
- Добавлена статистика количества файлов по каждой категории
- Улучшен интерфейс с цветовым кодированием статистики
- Добавлена адаптивность для мобильных устройств

**Новые функции:**
- Вкладка "Мои файлы" - показывает только файлы, отправленные текущим пользователем
- Вкладка "Файлы от других" - показывает файлы, отправленные другими участниками
- Счетчики файлов в каждой вкладке для быстрой навигации
- Цветовое кодирование статистики в футере
- Сохранение всех существующих функций поиска и фильтрации

**Затронутые файлы:**
- `client/src/routes/kanbanBoard/Task/subcomponents/chatTaskModal/chatTaskModal.jsx`
- `client/src/routes/kanbanBoard/Task/subcomponents/chatTaskModal/chatTaskModal.scss`
- `client/src/routes/kanbanBoard/Task/subcomponents/chatTaskModal/ChatFileUploader.jsx`
- `client/src/routes/kanbanBoard/Task/subcomponents/chatTaskModal/ChatFileManager.jsx`
- `client/src/routes/kanbanBoard/Task/subcomponents/chatTaskModal/ChatFileManager.scss`

**Функциональность:**
- Пользователи могут делать скриншот (Print Screen) и вставлять его в чат через Ctrl+V
- Автоматическое определение типа файла (изображение)
- Создание уникальных имен файлов для избежания конфликтов
- Интеграция с существующей системой загрузки файлов
- Поддержка множественной вставки изображений
- Полное отсутствие дублирования сообщений
- Защита от повторной отправки одинаковых скриншотов
- Удобное разделение файлов по отправителям в менеджере
- Быстрая навигация между личными и общими файлами
- Улучшенная статистика и визуализация
